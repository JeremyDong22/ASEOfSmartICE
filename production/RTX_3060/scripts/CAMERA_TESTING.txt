CAMERA CONNECTION TESTING SYSTEM
=================================

Purpose: Comprehensive testing of UNV camera RTSP connections for production deployment

Location: production/RTX_3060/scripts/test_camera_connections.py
Version: 1.0.0
Last Updated: 2025-11-14

FEATURES
--------
1. Parallel testing of multiple cameras (10 max by default)
2. Ping test with RTT measurement (<500ms required)
3. RTSP connection time measurement (<10s timeout)
4. Resolution detection and verification
5. FPS verification (expected 20 FPS ±10% = 18-22 FPS)
6. 30-second recording test
7. Video file integrity check using ffprobe
8. Bandwidth estimation (Mbps)
9. Auto-generate/update cameras_config.json
10. Auto-disable unstable cameras

USAGE EXAMPLES
--------------

# 1. Test specific camera IPs
python3 test_camera_connections.py --ips 202.168.40.35 202.168.40.22

# 2. Interactive mode (prompts for IPs)
python3 test_camera_connections.py --interactive

# 3. Test all cameras in existing config
python3 test_camera_connections.py --validate-config cameras_config.json

# 4. Keep test videos after testing (default: delete)
python3 test_camera_connections.py --ips 202.168.40.35 --keep-videos

# 5. Use convenience shell script
./run_camera_test.sh

TEST CRITERIA (PASS/FAIL)
-------------------------
PASS requires ALL of:
- Ping RTT < 500ms
- RTSP connection within 10 seconds
- Actual FPS within 18-22 FPS (20 ±10%)
- 30-second recording completes successfully
- Video file can be read by ffprobe (integrity check)

FAIL if ANY of:
- Ping timeout or RTT >= 500ms
- Cannot connect to RTSP stream
- FPS outside 18-22 range
- Recording fails or file is empty
- Video file is corrupted

OUTPUT FILES
------------

1. Test Report (JSON)
   Location: production/RTX_3060/tests/camera_test_reports/
   Filename: camera_test_report_YYYYMMDD_HHMMSS.json
   Contents: Complete test results for all cameras

2. Test Videos (MP4)
   Location: production/RTX_3060/tests/camera_test_videos/
   Filename: test_202_168_40_35_YYYYMMDD_HHMMSS.mp4
   Duration: 30 seconds each
   Note: Deleted automatically unless --keep-videos specified

3. Updated Config (JSON)
   Location: production/RTX_3060/scripts/cameras_config.json
   Contents: Only validated cameras with enabled=true
   Failed cameras marked with enabled=false

CAMERAS_CONFIG.JSON FORMAT
---------------------------
{
  "camera_35": {
    "ip": "202.168.40.35",
    "port": 554,
    "username": "admin",
    "password": "123456",
    "stream_path": "/media/video1",
    "resolution": [2592, 1944],
    "fps": 20,
    "enabled": true,
    "last_test": "2025-11-14T20:00:00",
    "test_results": {
      "ping_rtt_ms": 12.5,
      "connection_time_ms": 245.3,
      "actual_fps": 19.8,
      "bandwidth_mbps": 4.5
    },
    "division_name": "A区",
    "location_id": "ybl_mianyang",
    "notes": "Front area camera - main dining hall"
  }
}

EXAMPLE OUTPUT
--------------

======================================================================
Starting parallel camera tests for 2 camera(s)
======================================================================

======================================================================
Testing camera: 202.168.40.35
RTSP URL: rtsp://admin:***@202.168.40.35:554/media/video1
======================================================================
[202.168.40.35] Running ping test...
[202.168.40.35] Ping: SUCCESS (RTT: 12.5ms)
[202.168.40.35] Testing RTSP connection...
[202.168.40.35] Connection: SUCCESS (245ms)
[202.168.40.35] Resolution: 2592x1944
[202.168.40.35] Testing FPS and recording 30s video...
[202.168.40.35] FPS: 19.82 (expected 20 ±10%)
[202.168.40.35] FPS: PASS
[202.168.40.35] Recording: SUCCESS (45.3MB, 12.08 Mbps)
[202.168.40.35] Checking video integrity...
[202.168.40.35] Integrity: PASS (duration: 30.1s)

======================================================================
Camera 202.168.40.35: PASS (took 35.2s)
======================================================================

======================================================================
TEST SUMMARY
======================================================================
Total cameras tested: 2
Passed: 2 (100.0%)
Failed: 0

Detailed report saved to: production/RTX_3060/tests/camera_test_reports/camera_test_report_20251114_200000.json
======================================================================

INDIVIDUAL RESULTS:
======================================================================
202.168.40.35        | PASS | Ping:   12.5ms | FPS:  19.8 | Bandwidth:  12.08Mbps
202.168.40.22        | PASS | Ping:   15.2ms | FPS:  20.1 | Bandwidth:  11.95Mbps
======================================================================

======================================================================
Updating cameras_config.json
======================================================================
Loaded existing config with 2 camera(s)

Config updated: cameras_config.json
Total cameras: 2
Enabled: 2
Disabled: 0
======================================================================

Cleaning up test videos from production/RTX_3060/tests/camera_test_videos...
Removed 2 test video(s)

Test completed: 2025-11-14 20:05:32
SUCCESS: 2/2 camera(s) passed

EXIT CODES
----------
0 - At least one camera passed all tests
1 - All cameras failed OR no cameras provided

TECHNICAL NOTES
---------------

1. Parallel Processing:
   - Uses ThreadPoolExecutor for concurrent testing
   - Default: 10 cameras in parallel
   - Each camera has 60s timeout
   - Adjust with --max-workers parameter

2. Test Video Encoding:
   - Codec: MPEG-4 (fourcc: mp4v)
   - FPS: 20 (matches camera spec)
   - Resolution: Auto-detected from stream
   - Duration: 30 seconds

3. Network Requirements:
   - All cameras must be on same network
   - Firewall must allow RTSP (port 554)
   - Sufficient bandwidth for 10 concurrent streams

4. Dependencies:
   - Python 3.7+
   - OpenCV (cv2) with FFMPEG support
   - ffprobe (optional, for integrity check)
   - ping command (system)

5. Error Handling:
   - Graceful degradation (continues testing other cameras)
   - Detailed error messages in report
   - Preserves existing config fields
   - Safe retry logic with timeouts

DEPLOYMENT WORKFLOW
-------------------

1. Initial Setup:
   # Test all cameras before deployment
   python3 test_camera_connections.py --ips 202.168.40.35 202.168.40.22 ...

2. Review Test Report:
   # Check JSON report in tests/camera_test_reports/
   cat tests/camera_test_reports/camera_test_report_*.json

3. Verify Config:
   # Check generated cameras_config.json
   cat cameras_config.json

4. Production Validation:
   # Periodically re-test existing config
   python3 test_camera_connections.py --validate-config cameras_config.json

5. Troubleshooting:
   # Keep test videos for inspection
   python3 test_camera_connections.py --ips 202.168.40.35 --keep-videos

TROUBLESHOOTING
---------------

Problem: Ping timeout
Solution: Check network connectivity, verify IP address

Problem: Connection timeout
Solution: Verify RTSP credentials, check firewall rules

Problem: FPS out of range
Solution: Check network bandwidth, camera load

Problem: Recording fails
Solution: Check disk space, verify OpenCV installation

Problem: ffprobe not found
Solution: Install ffmpeg package (integrity check will be skipped)

Problem: All cameras fail
Solution: Check if you're on same network, verify VPN/routing

BEST PRACTICES
--------------

1. Test cameras during off-peak hours
2. Run tests before production deployment
3. Re-test weekly to detect degradation
4. Keep test reports for historical analysis
5. Monitor bandwidth usage during parallel tests
6. Verify config changes after updates
7. Clean up test videos regularly (unless debugging)

FUTURE ENHANCEMENTS
-------------------

- Email/Slack notifications for test results
- Historical trending analysis
- Auto-scheduling (cron integration)
- Web dashboard for test results
- Support for sub-stream testing (/102)
- GPU memory usage monitoring
- Latency measurement (frame-to-display)
- Advanced diagnostics (packet loss, jitter)
