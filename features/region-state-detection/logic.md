# 区域状态检测逻辑

## 目的

检测餐厅指定分区（Division）的服务员在岗情况和服务状态，通过分区和服务区域的组合实现三态监控。系统不仅监控服务员是否在岗，还能判断服务员是否忙碌。

## 版本更新

### v5.0.0 (2025-11-13)
- 引入分区（Division）+ 服务区域（Service Areas）双层结构
- 三态检测：绿色（服务中）、黄色（忙碌）、红色（无人）
- 支持一个分区内多个服务区域
- 新增配置文件 `region_config.json`
- 保持1秒防抖缓冲机制

## 核心组件

### 1. 双层区域定义

**分区（Division）：**
- 需要监控的餐厅服务分区（如A区、B区、C区）
- 通过多边形定义整个监控范围
- 用于判断服务员是否在该区域

**服务区域（Service Areas）：**
- 分区内的特定工作站点（如收银台、备餐台、水吧等）
- 一个分区可包含多个服务区域
- 用于判断服务员是否在忙碌状态

**区域设置流程：**
1. 显示视频首帧
2. 用户交互式绘制分区多边形（最少3个点）
3. 用户交互式绘制服务区域多边形（可多个）
4. 系统保存至 `region_config.json` 供复用
5. 区域在视频上显示为彩色叠加层

### 2. 两阶段检测流程

**阶段1：人员检测（YOLOv8m）**
- 检测摄像头画面中的所有人员
- 置信度阈值：0.3（默认）
- 最小人员尺寸：40x40像素
- 筛选检测结果，仅保留ROI多边形内的人员
- 使用边界框中心点进行ROI交叉测试

**阶段2：员工分类（YOLO11n-cls）**
- 从画面裁剪每个检测到的人员
- 分类为以下之一：
  - **Waiter（服务员）**（员工/工作人员）
  - **Customer（顾客）**
  - **Unknown（未知）**（低置信度 < 0.5）
- 分类模型：92.38%准确率，在1,505张图像（1080p裁剪）上训练

### 3. 三态检测逻辑

系统为每个监控分区维护三个状态，基于服务员位置智能判断：

**状态1：GREEN（绿色 - 服务中/空闲）**
- 服务员在分区内，但不在任何服务区域
- 表示服务员正在照顾顾客或在分区内巡视
- 视频叠加绿色半透明层（20%透明度）
- 这是期望的良好服务状态

**状态2：YELLOW（黄色 - 忙碌）**
- 服务员在分区内且在服务区域内
- 表示服务员正在服务区域忙碌（如收银、备餐）
- 视频叠加黄色半透明层（20%透明度）
- 提示服务员暂时无法照顾顾客

**状态3：RED（红色 - 无人/被忽略）**
- 分区内没有服务员
- 表示该区域无人照看，可能需要关注
- 视频叠加红色半透明层（20%透明度）
- 提醒管理者分配服务员

**状态转换规则：**
```
初始状态：RED（无服务员）
    ↓ 服务员进入分区（经过1秒防抖确认）
    ↓
服务员在分区但不在服务区域 → GREEN（服务中）
服务员在服务区域 → YELLOW（忙碌）
    ↓ 服务员离开分区
    ↓
返回 RED（无人）
```

**关键设计思想：**
- 通过服务员位置相对于服务区域的关系判断服务状态
- GREEN状态表示服务员可以响应顾客需求
- YELLOW状态表示服务员暂时忙于其他事务
- RED状态表示需要增派服务员

### 4. 防抖机制

**目的：** 防止短暂遮挡或检测间隙导致的误报

**服务员检测防抖（1秒）：**
- 首次检测到服务员时，系统进入"防抖"状态
- 服务员必须连续检测满1秒
- 仅在1秒后服务员状态才被"确认"
- 如果防抖期间服务员消失，计时器重置

**防抖状态：**
- **首次检测**：看到服务员，防抖计时器启动
- **防抖中**：已过0-1秒，服务员在场但未确认
- **已确认**：已过≥1秒，服务员状态正式生效
- **重置**：未检测到服务员，计时器重置为空

这防止了以下情况的闪烁警报：
- 服务员被顾客暂时遮挡
- 检测模型短暂误报
- 服务员快速移动穿过ROI边缘

### 5. 配置文件系统

**配置文件：`region_config.json`**

系统支持两种运行模式：

**交互模式（Interactive Mode）：**
- 使用 `--interactive` 参数启动
- 分步引导用户绘制分区和服务区域
- 自动保存配置到 `region_config.json`
- 适用于首次设置或修改监控区域

**默认模式（Default Mode）：**
- 不使用 `--interactive` 参数
- 自动加载 `region_config.json` 配置
- 快速启动，适合日常使用
- 如无配置文件会提示使用交互模式

**配置文件结构：**
```json
{
  "division": [[x1,y1], [x2,y2], ...],
  "service_areas": [
    [[x1,y1], [x2,y2], ...],
    [[x1,y1], [x2,y2], ...]
  ],
  "frame_size": [width, height],
  "video": "path/to/video.mp4"
}
```

## 应用场景

### 餐厅服务监控与优化
- **用餐区域分区：** 将餐厅划分为多个分区（A区、B区、C区），每个分区独立监控
- **服务区域定义：** 在每个分区内标注收银台、备餐台、水吧等工作站点
- **状态实时可视化：** 通过颜色即时了解每个分区的服务状态

### 三态系统优势
- **GREEN（服务中）：** 确认服务员正在照顾顾客，服务质量有保障
- **YELLOW（忙碌）：** 识别服务员在工作站忙碌，可能需要协调支援
- **RED（无人）：** 立即发现无人照看的区域，快速调派人员

### 实际应用价值
1. **服务质量提升：** 确保顾客始终能获得及时服务
2. **人员调度优化：** 基于状态数据合理分配服务员
3. **忙碌状态识别：** 区分服务员是在照顾顾客还是在工作站忙碌
4. **历史分析：** 统计各状态占比，评估服务效率

### 使用案例示例
```
场景：B区用餐区（8张桌，32座位）
分区（Division）：覆盖15-22号桌的多边形
服务区域（Service Areas）：
  - 服务区域1：备餐台（获取餐具、调料等）
  - 服务区域2：水吧（制作饮品）

状态解读：
- GREEN：服务员在餐桌间巡视或为顾客服务 ✅ 最佳状态
- YELLOW：服务员在备餐台/水吧准备物品 ⚠️ 暂时忙碌
- RED：分区内没有服务员 ❌ 需要立即安排

典型场景：
1. 服务员为22号桌点餐 → GREEN（正在服务）
2. 服务员去水吧制作饮品 → YELLOW（准备中）
3. 所有服务员都离开B区 → RED（无人照看）
```

## 技术参数

| 参数 | 默认值 | 用途 |
|------|--------|------|
| 人员检测置信度 | 0.3 | YOLOv8m检测阈值 |
| 员工分类置信度 | 0.5 | YOLO11n-cls分类阈值 |
| 最小人员尺寸 | 40x40像素 | 过滤非常小/远距离的人员 |
| 服务员防抖时长 | 1.0秒 | 防止误报 |
| 状态叠加透明度 | 20% (0.2 alpha) | 状态颜色叠加层不透明度 |
| GREEN颜色 | (0,255,0) | 服务中状态 |
| YELLOW颜色 | (0,255,255) | 忙碌状态 |
| RED颜色 | (0,0,255) | 无人状态 |

## 性能特性

**处理速度：**
- 1080p视频：每帧约30-40毫秒（YOLOv8m + YOLO11n-cls）
- 2K视频（2560x1440）：每帧约60-80毫秒（估计）
- 实时能力：是，需GPU加速

**准确率：**
- 人员检测：YOLOv8m（优于YOLOv8s）
- 员工分类：92.38%准确率
- 误报率：<5%（启用防抖后）

## 输出

**视频标注：**
- 状态叠加层：GREEN/YELLOW/RED半透明色彩覆盖（20%透明度）
- 分区边界：青色多边形，10%填充，3像素线宽
- 服务区域边界：洋红色多边形，5%填充，2像素线宽
- 服务员框：绿色，带置信度分数
- 顾客框：红色，带置信度分数
- 未知框：灰色（低置信度）

**屏幕统计信息：**
- 处理FPS
- 帧计数
- 阶段1/阶段2计时
- 当前服务员/顾客数量
- 当前状态（GREEN/YELLOW/RED）或防抖状态
- 分区多边形点数
- 服务区域数量

**终端摘要：**
- 处理的总帧数
- 平均处理FPS
- 阶段计时明细
- 检测总数（人员/服务员/顾客）
- 状态统计（GREEN/YELLOW/RED各状态帧数与百分比）
- 2K性能估算

**命令行使用：**
```bash
# 交互模式 - 首次设置
python3 region-state-detection.py --video videos/test.mp4 --interactive

# 默认模式 - 使用已有配置
python3 region-state-detection.py --video videos/test.mp4

# 限制处理时长
python3 region-state-detection.py --video videos/test.mp4 --duration 30
```
