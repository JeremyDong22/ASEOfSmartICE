# 区域状态检测逻辑

## 目的

检测餐厅指定服务区域（A区、B区、C区等）的服务员在岗情况，确保充足覆盖并防止服务空缺。系统监控每个区域是STAFFED（在岗）还是UNSTAFFED（脱岗）。

## 核心组件

### 1. 感兴趣区域（ROI）定义

- 每个服务区域通过摄像头视野中绘制的多边形定义
- ROI使用视频首帧交互式创建
- 多边形坐标保存至 `roi_config.json` 供复用
- 使用射线投射算法判断检测到的人员是否在ROI内

**ROI设置流程：**
- 显示视频首帧
- 用户点击定义多边形顶点（最少3个点）
- 系统验证并保存ROI配置
- ROI在视频上显示为半透明叠加层

### 2. 两阶段检测流程

**阶段1：人员检测（YOLOv8m）**
- 检测摄像头画面中的所有人员
- 置信度阈值：0.3（默认）
- 最小人员尺寸：40x40像素
- 筛选检测结果，仅保留ROI多边形内的人员
- 使用边界框中心点进行ROI交叉测试

**阶段2：员工分类（YOLO11n-cls）**
- 从画面裁剪每个检测到的人员
- 分类为以下之一：
  - **Waiter（服务员）**（员工/工作人员）
  - **Customer（顾客）**
  - **Unknown（未知）**（低置信度 < 0.5）
- 分类模型：92.38%准确率，在1,505张图像（1080p裁剪）上训练

### 3. 状态机逻辑

系统为每个监控区域维护两个主要状态：

**状态1：STAFFED（在岗）**
- ROI内至少有一名服务员确认在场
- 正常运营 - 绿色状态指示
- 持续监控服务员离开情况

**状态2：UNSTAFFED（脱岗）**
- ROI内超过5秒未检测到服务员
- 警报条件 - 触发视觉警告
- 视频输出上显示红色闪烁叠加层

**状态转换：**
```
UNSTAFFED → STAFFED：当服务员确认在场 ≥1秒（防抖）
STAFFED → UNSTAFFED：当超过5秒未检测到服务员（警报阈值）
```

### 4. 防抖机制

**目的：** 防止短暂遮挡或检测间隙导致的误报

**服务员检测防抖（1秒）：**
- 首次检测到服务员时，系统进入"防抖"状态
- 服务员必须连续检测满1秒
- 仅在1秒后服务员状态才被"确认"
- 如果防抖期间服务员消失，计时器重置

**防抖状态：**
- **首次检测**：看到服务员，防抖计时器启动
- **防抖中**：已过0-1秒，服务员在场但未确认
- **已确认**：已过≥1秒，服务员状态正式生效
- **重置**：未检测到服务员，计时器重置为空

这防止了以下情况的闪烁警报：
- 服务员被顾客暂时遮挡
- 检测模型短暂误报
- 服务员快速移动穿过ROI边缘

### 5. 警报系统

**警报触发条件：**
- 超过5秒未检测到确认的服务员
- 仅在之前至少确认过一次服务员后触发
- 视频开始时在看到任何服务员前不触发

**警报视觉反馈：**
- 红色闪烁叠加层（30%不透明度）覆盖整个画面
- 屏幕上显示警报持续时间计数器
- 状态文本显示"ALERT: No waiter for X.Xs"（警报：X.X秒无服务员）
- 持续直到服务员重新进入并通过防抖

**警报追踪指标：**
- 警报激活的总帧数
- 最大连续警报持续时间
- 警报占总视频时间的百分比

## 应用场景

### 餐厅服务覆盖
- **用餐区域：** 确保每个分区（A区、B区、C区）有专职服务员
- **服务站点：** 监控饮料站、POS区域、迎宾台
- **厨房入口：** 追踪厨房与用餐区之间的服务员流动

### 优势
- **实时警报：** 区域脱岗时立即通知
- **历史分析：** 回顾随时间变化的覆盖模式
- **人员优化：** 识别覆盖不足的区域以改进排班
- **服务质量：** 防止因服务员缺席导致的顾客等待时间

### 使用案例示例
```
区域：B区餐桌区（8张桌，32个座位容量）
ROI：覆盖15-22号桌的多边形
警报阈值：5秒
预期覆盖：任何时候最少1名服务员

以下情况触发警报：
- 服务员离开分区上厕所
- 服务员被调去帮助其他区域
- 交班间隙
- 厨房紧急情况/事故
```

## 技术参数

| 参数 | 默认值 | 用途 |
|------|--------|------|
| 人员检测置信度 | 0.3 | YOLOv8m检测阈值 |
| 员工分类置信度 | 0.5 | YOLO11n-cls分类阈值 |
| 最小人员尺寸 | 40x40像素 | 过滤非常小/远距离的人员 |
| 服务员防抖时长 | 1.0秒 | 防止误报 |
| 警报阈值 | 5.0秒 | 生产环境人员缺口容忍度 |
| 闪烁叠加层颜色 | 红色(0,0,255) | 视觉警报指示器 |
| 闪烁透明度 | 30% (0.3 alpha) | 叠加层不透明度 |

## 性能特性

**处理速度：**
- 1080p视频：每帧约30-40毫秒（YOLOv8m + YOLO11n-cls）
- 2K视频（2560x1440）：每帧约60-80毫秒（估计）
- 实时能力：是，需GPU加速

**准确率：**
- 人员检测：YOLOv8m（优于YOLOv8s）
- 员工分类：92.38%准确率
- 误报率：<5%（启用防抖后）

## 输出

**视频标注：**
- ROI边界：青色多边形，10%填充
- 人员框：青色（阶段1检测）
- 服务员框：绿色，带置信度分数
- 顾客框：红色，带置信度分数
- 未知框：灰色（低置信度）

**屏幕统计信息：**
- 处理FPS
- 帧计数
- 阶段1/阶段2计时
- 当前服务员/顾客数量
- 警报状态或防抖状态
- ROI多边形点数

**终端摘要：**
- 处理的总帧数
- 平均处理FPS
- 阶段计时明细
- 检测总数（人员/服务员/顾客）
- 警报统计（帧数、最长持续时间、百分比）
- 2K性能估算
